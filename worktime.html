<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>æˆ‘çš„ä¸Šç­è®°å½•</title>
<style>
  :root{
    --bg: #ffffff;
    --card: #f6f7f9;
    --border: #e6e8eb;
    --text: #111418;
    --muted: #6b7280;
    --primary: #2563eb;
    --accent: #10b981;
    --danger: #ef4444;
    --shadow: 0 6px 24px rgba(0,0,0,.08);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg: #0b0d10;
      --card: #12161b;
      --border: #1f242b;
      --text: #e5e7eb;
      --muted: #9aa3af;
      --primary: #60a5fa;
      --accent: #34d399;
      --danger: #f87171;
      --shadow: 0 8px 28px rgba(0,0,0,.35);
    }
  }
  [data-theme="light"]{
    --bg:#ffffff;--card:#f6f7f9;--border:#e6e8eb;--text:#111418;--muted:#6b7280;--primary:#2563eb;--accent:#10b981;--danger:#ef4444;--shadow:0 6px 24px rgba(0,0,0,.08);
  }
  [data-theme="dark"]{
    --bg:#0b0d10;--card:#12161b;--border:#1f242b;--text:#e5e7eb;--muted:#9aa3af;--primary:#60a5fa;--accent:#34d399;--danger:#f87171;--shadow:0 8px 28px rgba(0,0,0,.35);
  }

  html,body{height:100%}
  body{
    margin:0;
    font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Helvetica Neue", Arial, "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  .app{
    max-width:920px;
    margin:0 auto;
    padding-bottom:86px; /* bottom nav space */
  }
  header{
    position:sticky; top:0; z-index:3;
    background:var(--bg);
    border-bottom:1px solid var(--border);
    backdrop-filter:saturate(160%) blur(6px);
  }
  header .bar{
    display:flex; align-items:center; gap:12px;
    padding:14px 16px;
  }
  header h1{font-size:18px; margin:0; font-weight:700}
  header .sub{color:var(--muted); font-size:13px}

  .view{display:none; padding:16px}
  .view.active{display:block}

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    box-shadow:var(--shadow);
  }

  .home-form{padding:16px}
  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  label{font-size:13px; color:var(--muted)}
  input,select,button,textarea{
    font:inherit; color:var(--text);
  }
  input[type="date"],input[type="time"],input[type="text"],input[type="number"],select,textarea{
    width:100%; box-sizing:border-box; padding:12px 12px;
    border-radius:10px; border:1px solid var(--border); background:transparent;
    outline:none;
  }
  input::placeholder,textarea::placeholder{color:var(--muted)}
  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    gap:8px; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:var(--primary); color:#fff; cursor:pointer; text-decoration:none;
  }
  .btn.ghost{background:transparent; color:var(--text)}
  .btn.danger{background:var(--danger); border-color:transparent}
  .btn.flat{background:transparent; border-color:var(--border); color:var(--text)}
  .btn:disabled{opacity:.5; cursor:not-allowed}

  .hint{color:var(--muted); font-size:14px}
  .hint.big{font-size:16px; opacity:.65}
  .muted{color:var(--muted)}

  .list{padding:12px}
  .row{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:12px 8px; border-bottom:1px dashed var(--border);
  }
  .row:last-child{border-bottom:0}
  .chip{
    display:inline-flex; align-items:center; gap:6px; padding:4px 8px;
    border-radius:999px; border:1px solid var(--border); background:rgba(0,0,0,.03);
  }

  /* Calendar */
  .cal-header{display:flex; align-items:center; justify-content:space-between; padding:12px 16px}
  .cal-grid{
    display:grid; gap:6px; padding:10px 12px 16px 12px;
    grid-template-columns: repeat(7,1fr);
  }
  .cal-weekday{font-size:12px; color:var(--muted); text-align:center}
  .cal-cell{
    min-height:74px; border:1px solid var(--border); border-radius:10px; padding:6px; position:relative; background:var(--card);
    display:flex; flex-direction:column; gap:4px;
  }
  .cal-cell .d{font-size:12px; color:var(--muted)}
  .cal-cell .amt{margin-top:auto; font-size:12px; color:var(--accent); font-weight:600}
  .cal-cell .hrs{font-size:11px; color:var(--muted)}
  .cal-cell.today{outline:2px solid var(--primary)}
  .cal-cell.out{opacity:.4}

  /* Charts */
  .canvas-wrap{padding:16px}
  canvas{width:100%; height:280px; display:block}

  /* Heatmap */
  .hm-wrap{padding:16px}
  .hm-grid{display:grid; grid-template-columns:repeat(13,1fr); gap:4px}
  .hm-cell{
    aspect-ratio:1/1; border-radius:4px; background:#e5e7eb; position:relative;
  }
  [data-theme="dark"] .hm-cell{background:#1f2937}
  .hm-cell[data-v="1"]{background:#d1fae5}
  .hm-cell[data-v="2"]{background:#a7f3d0}
  .hm-cell[data-v="3"]{background:#6ee7b7}
  .hm-cell[data-v="4"]{background:#34d399}
  .hm-cell[data-v="5"]{background:#10b981}
  .hm-cell[data-v="6"]{background:#059669}
  .hm-meta{display:flex; justify-content:space-between; color:var(--muted); font-size:12px; margin-top:8px}

  /* Bottom nav */
  .tabbar{
    position:fixed; left:0; right:0; bottom:0; z-index:4; background:var(--bg); border-top:1px solid var(--border);
    padding:8px env(safe-area-inset-right) 8px env(safe-area-inset-left);
  }
  .tabs{
    max-width:920px; margin:0 auto; display:grid; grid-template-columns:repeat(4,1fr); gap:8px;
  }
  .tab{
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
    padding:8px 6px; border-radius:12px; border:1px solid transparent; color:var(--muted); text-decoration:none; cursor:pointer;
  }
  .tab.active{border-color:var(--border); color:var(--text); background:var(--card)}
  .tab .ico{font-size:18px; line-height:1}
  .tab .txt{font-size:12px}
  .foot-space{height:80px}

  /* Small helpers */
  .flex{display:flex; gap:8px; align-items:center}
  .right{margin-left:auto}
  .sep{height:1px; background:var(--border); margin:8px 0}
  .title{padding:14px 16px; font-weight:700}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="bar">
      <h1>ä¸Šç­è®°å½•</h1>
      <div class="sub" id="todaySum"></div>
      <div class="right flex">
        <span class="chip"><span>ä¸»é¢˜</span>
          <select id="themeSel" aria-label="ä¸»é¢˜">
            <option value="system">è·Ÿéšç³»ç»Ÿ</option>
            <option value="light">æµ…è‰²</option>
            <option value="dark">æ·±è‰²</option>
          </select>
        </span>
      </div>
    </div>
  </header>

  <!-- HOME -->
  <section class="view active" id="v-home">
    <div class="card home-form">
      <div class="grid g3">
        <div>
          <label>æ—¥æœŸ</label>
          <input type="date" id="date" />
        </div>
        <div>
          <label>å¼€å§‹æ—¶é—´</label>
          <input type="time" id="start" step="300" />
        </div>
        <div>
          <label>ç»“æŸæ—¶é—´</label>
          <input type="time" id="end" step="300" />
        </div>
      </div>
      <div class="grid" style="margin-top:12px">
        <input type="text" id="note" placeholder="å¤‡æ³¨ï¼ˆå¯ç©ºï¼‰" />
        <div class="flex">
          <button class="btn" id="addShiftBtn">æ·»åŠ æ—¶é—´æ®µ</button>
          <button class="btn flat" id="clearTodayBtn" title="ä»…æ¸…é™¤é€‰å®šæ—¥æœŸçš„è®°å½•">æ¸…é™¤å½“æ—¥</button>
          <span class="right hint">æç¤ºï¼šæ—¶è–ªåœ¨â€œè®¾ç½®â€é¡µæŒ‰æ—¶é—´æ®µå®šä¹‰ï¼Œå·¥èµ„å°†è‡ªåŠ¨æŒ‰è§„åˆ™æ‹†åˆ†è®¡ç®—ã€‚</span>
        </div>
      </div>
    </div>

    <div class="title">ä»Šå¤©</div>
    <div class="card">
      <div class="list" id="todayList">
        <div class="hint big" id="homeHint" style="padding:8px 4px; opacity:.7">ä»Šå¤©çš„å·¥ä½œè®¡åˆ’æ˜¯ï¼Ÿ</div>
      </div>
      <div class="sep"></div>
      <div class="flex" style="padding:12px">
        <div class="muted">å½“æ—¥å·¥æ—¶</div>
        <div class="right" id="todayHours">0 h</div>
      </div>
      <div class="flex" style="padding:0 12px 12px 12px">
        <div class="muted">å½“æ—¥å·¥èµ„</div>
        <div class="right" id="todayPay">$0.00</div>
      </div>
    </div>
    <div class="foot-space"></div>
  </section>

  <!-- CALENDAR -->
  <section class="view" id="v-cal">
    <div class="card">
      <div class="cal-header">
        <button class="btn flat" id="prevMon">â€¹ ä¸Šæœˆ</button>
        <div class="flex">
          <select id="calYear"></select>
          <select id="calMon"></select>
        </div>
        <button class="btn flat" id="nextMon">ä¸‹æœˆ â€º</button>
      </div>
      <div class="cal-grid" id="calWeekdays"></div>
      <div class="cal-grid" id="calGrid"></div>
    </div>
    <div class="foot-space"></div>
  </section>

  <!-- STATS -->
  <section class="view" id="v-stats">
    <div class="card canvas-wrap">
      <div class="hint">æ¯å‘¨æ€»è§ˆï¼ˆè¿‘ 12 å‘¨ï¼‰</div>
      <canvas id="barChart" width="800" height="320" aria-label="æ¯å‘¨å·¥æ—¶ä¸å·¥èµ„"></canvas>
      <div class="hint" style="margin-top:6px">æŸ±ï¼šå·¥æ—¶ï¼ˆå°æ—¶ï¼‰ï¼›æŠ˜çº¿ï¼šå·¥èµ„ï¼ˆ$ï¼‰</div>
    </div>

    <div class="card hm-wrap" style="margin-top:16px">
      <div class="hint">ä¸Šç­æ¬¡æ•°çƒ­åŠ›å›¾ï¼ˆè¿‘ 12 å‘¨ Ã— å‘¨ä¸€â€“å‘¨æ—¥ï¼‰</div>
      <div class="hm-grid" id="heatGrid"></div>
      <div class="hm-meta"><span class="muted">å°‘</span><span class="muted">å¤š</span></div>
    </div>
    <div class="foot-space"></div>
  </section>

  <!-- SETTINGS -->
  <section class="view" id="v-settings">
    <div class="card" style="padding:16px">
      <div class="hint" style="margin-bottom:8px">æ—¶è–ªè§„åˆ™ï¼ˆæŒ‰æ¯æ—¥æ—¶é—´æ®µï¼‰</div>
      <div class="grid g3">
        <div><label>å¼€å§‹</label><input type="time" id="rateStart" value="09:00" step="300"></div>
        <div><label>ç»“æŸ</label><input type="time" id="rateEnd" value="18:00" step="300"></div>
        <div><label>æ—¶è–ªï¼ˆ$/hï¼‰</label><input type="number" id="ratePay" step="0.01" min="0" value="30"></div>
      </div>
      <div class="flex" style="margin-top:12px">
        <button class="btn" id="addRateBtn">æ·»åŠ æ—¶è–ªè§„åˆ™</button>
        <button class="btn flat" id="resetRateBtn" title="æ¢å¤é»˜è®¤æ—¥é—´/æ™šé—´ç¤ºä¾‹">æ¢å¤é»˜è®¤</button>
        <span class="right hint">æç¤ºï¼šè§„åˆ™æŒ‰æ—¶é—´åŒ¹é…ï¼Œä¸æ”¯æŒè·¨åˆå¤œï¼ˆå¯æŒ‰å¤©æ‹†åˆ†å½•å…¥ï¼‰ã€‚</span>
      </div>

      <div class="sep"></div>
      <div class="list" id="rateList"></div>
    </div>

    <div class="card" style="padding:16px; margin-top:16px">
      <div class="hint" style="margin-bottom:8px">æ•°æ®</div>
      <div class="flex">
        <button class="btn flat" id="exportBtn">å¯¼å‡º JSON</button>
        <label class="btn flat" for="importFile">å¯¼å…¥ JSON</label>
        <input id="importFile" type="file" accept="application/json" style="display:none">
        <button class="btn danger right" id="wipeBtn">æ¸…ç©ºå…¨éƒ¨æ•°æ®</button>
      </div>
    </div>
    <div class="foot-space"></div>
  </section>

  <!-- Bottom Nav -->
  <nav class="tabbar">
    <div class="tabs">
      <a class="tab active" data-to="v-home"><span class="ico">ğŸ </span><span class="txt">é¦–é¡µ</span></a>
      <a class="tab" data-to="v-cal"><span class="ico">ğŸ“…</span><span class="txt">æ—¥å†</span></a>
      <a class="tab" data-to="v-stats"><span class="ico">ğŸ“Š</span><span class="txt">ç»Ÿè®¡</span></a>
      <a class="tab" data-to="v-settings"><span class="ico">âš™ï¸</span><span class="txt">è®¾ç½®</span></a>
    </div>
  </nav>
</div>

<script>
/* ------------------------- ç®€æ˜“æ•°æ®å±‚ï¼ˆlocalStorageï¼‰ ------------------------- */
const db = {
  load(){
    try{
      const raw = JSON.parse(localStorage.getItem('worklog-db')||'{}');
      return {
        shifts: raw.shifts||[], // {id,date:'YYYY-MM-DD',start:'HH:mm',end:'HH:mm',note}
        rates: raw.rates||[],   // {id,start:'HH:mm',end:'HH:mm',pay:number}
        theme: raw.theme || 'system'
      }
    }catch(e){ return {shifts:[],rates:[],theme:'system'} }
  },
  save(state){
    localStorage.setItem('worklog-db', JSON.stringify(state));
  }
}
let state = db.load();

/* ------------------------- å·¥å…·å‡½æ•° ------------------------- */
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const fmtMoney = v => '$' + (Math.round(v*100)/100).toFixed(2);
function todayStr(){
  const d = new Date();
  return d.toISOString().slice(0,10);
}
function parseHM(hm){ // 'HH:mm' -> minutes from 0:00
  const [h,m] = hm.split(':').map(Number);
  return h*60 + m;
}
function minToHM(min){
  const h = Math.floor(min/60), m = min%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function uid(){ return Math.random().toString(36).slice(2,9); }

function sameDay(a,b){ return a===b; }
function getWeekKey(isoDate){ // YYYY-Www (Mon-based)
  const d = new Date(isoDate+'T00:00:00');
  // set to Thursday of current week to get ISO week
  const day = (d.getUTCDay()+6)%7; // Mon=0..Sun=6
  d.setUTCDate(d.getUTCDate()-day+3);
  const firstThu = new Date(Date.UTC(d.getUTCFullYear(),0,4));
  const wk = 1 + Math.round((d - firstThu)/(7*24*3600*1000));
  return `${d.getUTCFullYear()}-W${String(wk).padStart(2,'0')}`;
}

/* ------------------------- å·¥èµ„è®¡ç®—ï¼ˆæŒ‰æ—¶è–ªè§„åˆ™æ‹†åˆ†ï¼‰ ------------------------- */
/* çº¦æŸï¼šä»…å¤„ç†åŒä¸€è‡ªç„¶æ—¥å†…çš„æ—¶é—´æ®µï¼›è·¨åˆå¤œè¯·æ‹†åˆ†æˆä¸¤æ¡ */
function calcPayForShift(shift, rates){
  const s = parseHM(shift.start), e = parseHM(shift.end);
  if(e<=s) return {minutes:0, pay:0, parts:[]};
  let totalMin = 0, totalPay = 0;
  const parts = [];
  for(const r of rates){
    const rs = parseHM(r.start), re = parseHM(r.end);
    if(re<=rs) continue; // ä¸æ”¯æŒè·¨æ—¥è§„åˆ™
    const ss = Math.max(s, rs);
    const ee = Math.min(e, re);
    if(ee>ss){
      const mins = ee-ss;
      const pay = (mins/60)*Number(r.pay||0);
      totalMin += mins;
      totalPay += pay;
      parts.push({range:`${minToHM(ss)}-${minToHM(ee)}`, mins, pay, rate:r});
    }
  }
  // è‹¥æœ‰æœªè¦†ç›–çš„æ—¶é—´æ®µï¼Œè§†ä¸º $0
  totalMin = Math.max(totalMin, e-s); // ç»Ÿè®¡å·¥æ—¶æŒ‰åŸåŒºé—´
  return {minutes: (e-s), pay: totalPay, parts};
}

function calcDay(dateStr){
  const shifts = state.shifts.filter(x=>x.date===dateStr);
  let mins=0, pay=0;
  const details=[];
  for(const sh of shifts){
    const r = calcPayForShift(sh, state.rates);
    mins += r.minutes;
    pay += r.pay;
    details.push({sh, ...r});
  }
  return {minutes:mins, pay, details, count:shifts.length};
}

/* ------------------------- æ¸²æŸ“ï¼šé¦–é¡µ ------------------------- */
function renderHome(){
  const d = $('#date').value || todayStr();
  const {minutes, pay, details, count} = calcDay(d);
  $('#todayHours').textContent = (Math.round(minutes/6)/10).toFixed(1) + ' h';
  $('#todayPay').textContent = fmtMoney(pay);

  const list = $('#todayList');
  list.innerHTML = '';
  const todays = state.shifts.filter(x=>x.date===d).sort((a,b)=>a.start.localeCompare(b.start));
  if(todays.length===0){
    const hint = document.createElement('div');
    hint.className='hint big';
    hint.style.padding='8px 4px';
    hint.style.opacity='.7';
    hint.textContent = 'ä»Šå¤©çš„å·¥ä½œè®¡åˆ’æ˜¯ï¼Ÿ';
    hint.id = 'homeHint';
    list.appendChild(hint);
  }else{
    const done = document.createElement('div');
    done.className='hint big';
    done.style.padding='8px 4px';
    done.style.opacity='.7';
    done.textContent = 'ä»Šå¤©ä¸Šç­ä¹Ÿè¾›è‹¦äº†ï¼';
    list.appendChild(done);
  }
  todays.forEach(sh=>{
    const row = document.createElement('div');
    row.className='row';
    const left = document.createElement('div');
    left.innerHTML = `<div><strong>${sh.start}â€“${sh.end}</strong> <span class="muted">${sh.note||''}</span></div>
      <div class="muted" style="font-size:13px">${sh.date}</div>`;
    const seg = calcPayForShift(sh, state.rates);
    const right = document.createElement('div');
    right.innerHTML = `<div class="right"><div style="text-align:right">${fmtMoney(seg.pay)}</div>
      <div class="muted" style="text-align:right;font-size:12px">${(seg.minutes/60).toFixed(2)} h</div></div>`;
    const del = document.createElement('button');
    del.className='btn flat'; del.textContent='åˆ é™¤';
    del.onclick=()=>{ state.shifts = state.shifts.filter(x=>x.id!==sh.id); persist(); refreshAll(); };
    row.append(left, right, del);
    list.appendChild(row);
  });

  // é¡¶éƒ¨åˆè®¡
  const td = calcDay(todayStr());
  $('#todaySum').textContent = `ä»Šå¤© ${ (td.minutes/60).toFixed(1) }h Â· ${ fmtMoney(td.pay) }`;
}

/* ------------------------- æ¸²æŸ“ï¼šæ—¥å† ------------------------- */
function buildCalendar(y,m){ // m: 0-11
  // å‘¨æ ‡é¢˜
  const wd = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
  const wdWrap = $('#calWeekdays');
  wdWrap.innerHTML='';
  wd.forEach(w=>{
    const d = document.createElement('div'); d.className='cal-weekday'; d.textContent='å‘¨'+w; wdWrap.appendChild(d);
  });

  const grid = $('#calGrid');
  grid.innerHTML='';
  const first = new Date(Date.UTC(y,m,1));
  const last = new Date(Date.UTC(y,m+1,0));
  let startOffset = (first.getUTCDay()+6)%7; // Mon first
  const days = last.getUTCDate();

  // å‰ç½®ç©ºæ ¼æ˜¾ç¤ºä¸Šæœˆ
  const prevLast = new Date(Date.UTC(y,m,0)).getUTCDate();
  for(let i=0;i<startOffset;i++){
    const n = document.createElement('div'); n.className='cal-cell out card';
    const dayNum = prevLast - startOffset + 1 + i;
    n.innerHTML = `<div class="d">${dayNum}</div>`;
    grid.appendChild(n);
  }

  for(let d=1; d<=days; d++){
    const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const {minutes, pay} = calcDay(ds);
    const cell = document.createElement('div'); cell.className='cal-cell card';
    if(ds===todayStr()) cell.classList.add('today');
    cell.innerHTML = `<div class="d">${d}</div>
      <div class="hrs">${ minutes? (minutes/60).toFixed(1)+' h':''}</div>
      <div class="amt">${ pay? fmtMoney(pay): ''}</div>`;
    cell.onclick=()=>{ // è·³å›é¦–é¡µé€‰ä¸­è¯¥æ—¥
      $('#date').value = ds;
      switchView('v-home');
      renderHome();
    }
    grid.appendChild(cell);
  }

  // åç½®å¡«å……
  const totalCells = startOffset + days;
  const tail = (7 - (totalCells % 7)) % 7;
  for(let i=0;i<tail;i++){
    const n = document.createElement('div'); n.className='cal-cell out card';
    n.innerHTML = `<div class="d">${i+1}</div>`;
    grid.appendChild(n);
  }
}

function renderCalendar(){
  const now = new Date();
  const ySel = $('#calYear'), mSel = $('#calMon');
  ySel.innerHTML=''; mSel.innerHTML='';
  const y0 = now.getFullYear()-3, y1 = now.getFullYear()+3;
  for(let y=y0;y<=y1;y++){
    const op = document.createElement('option'); op.value=y; op.textContent=y; ySel.appendChild(op);
  }
  for(let m=1;m<=12;m++){
    const op = document.createElement('option'); op.value=m-1; op.textContent=m; $('#calMon').appendChild(op);
  }
  const yInit = Number(localStorage.getItem('calY')) || now.getFullYear();
  const mInit = Number(localStorage.getItem('calM')) || now.getMonth();
  ySel.value = yInit; mSel.value = mInit;
  buildCalendar(yInit, mInit);
  $('#prevMon').onclick=()=>{
    let y = Number(ySel.value), m = Number(mSel.value)-1;
    if(m<0){m=11;y--;}
    ySel.value=y; mSel.value=m; localStorage.setItem('calY',y); localStorage.setItem('calM',m);
    buildCalendar(y,m);
  };
  $('#nextMon').onclick=()=>{
    let y = Number(ySel.value), m = Number(mSel.value)+1;
    if(m>11){m=0;y++;}
    ySel.value=y; mSel.value=m; localStorage.setItem('calY',y); localStorage.setItem('calM',m);
    buildCalendar(y,m);
  };
  ySel.onchange=mSel.onchange=()=>{
    localStorage.setItem('calY', ySel.value);
    localStorage.setItem('calM', mSel.value);
    buildCalendar(Number(ySel.value), Number(mSel.value));
  }
}

/* ------------------------- æ¸²æŸ“ï¼šç»Ÿè®¡ï¼ˆç®€æ˜“åŸç”Ÿç”»å¸ƒï¼‰ ------------------------- */
function weekBuckets(n=12){
  // è·å–è¿‡å» n å‘¨ï¼ˆå«æœ¬å‘¨ï¼‰ï¼Œæ±‡æ€»å°æ—¶ä¸å·¥èµ„
  const map = new Map();
  state.shifts.forEach(sh=>{
    const wk = getWeekKey(sh.date);
    if(!map.has(wk)) map.set(wk, {minutes:0, pay:0, count:0});
    const r = calcPayForShift(sh, state.rates);
    map.get(wk).minutes += r.minutes;
    map.get(wk).pay += r.pay;
    map.get(wk).count += 1;
  });
  // å–æœ€è¿‘ n å‘¨æŒ‰æ—¶é—´æ’åº
  const keys = [...map.keys()].sort();
  const lastN = keys.slice(-n);
  return lastN.map(k=>({week:k, hours: (map.get(k).minutes/60), pay: map.get(k).pay, count: map.get(k).count}));
}

function drawBarLineChart(){
  const c = $('#barChart');
  const ctx = c.getContext('2d');
  const data = weekBuckets(12);
  ctx.clearRect(0,0,c.width,c.height);
  // åæ ‡
  const pad = {l:50,r:50,t:20,b:40};
  const w = c.width - pad.l - pad.r;
  const h = c.height - pad.t - pad.b;

  // è½´èŒƒå›´
  const maxH = Math.max(1, Math.ceil(Math.max(...data.map(d=>d.hours),0)));
  const maxP = Math.max(1, Math.ceil(Math.max(...data.map(d=>d.pay),0)));

  // y è½´åˆ»åº¦ï¼ˆå·¦ï¼šå°æ—¶ï¼Œå³ï¼šå·¥èµ„ï¼‰
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
  ctx.font = "12px system-ui";
  ctx.textAlign="right";
  for(let i=0;i<=5;i++){
    const y = pad.t + h - (i/5)*h;
    const v = (i/5)*maxH;
    ctx.fillText(v.toFixed(0), pad.l-6, y+4);
    ctx.strokeStyle = 'rgba(128,128,128,0.15)';
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l+w, y); ctx.stroke();
  }
  ctx.textAlign="left";
  for(let i=0;i<=5;i++){
    const y = pad.t + h - (i/5)*h;
    const v = (i/5)*maxP;
    ctx.fillText('$'+v.toFixed(0), pad.l+w+6, y+4);
  }

  // x è½´æ ‡ç­¾
  ctx.textAlign='center';
  data.forEach((d,i)=>{
    const x = pad.l + (i+0.5)*w/data.length;
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
    ctx.fillText(d.week.slice(5), x, pad.t+h+18);
  });

  // æŸ±ï¼ˆå°æ—¶ï¼‰
  const barW = w/data.length*0.6;
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary');
  data.forEach((d,i)=>{
    const x = pad.l + (i+0.5)*w/data.length - barW/2;
    const y = pad.t + h - (d.hours/maxH)*h;
    ctx.fillRect(x, y, barW, (d.hours/maxH)*h);
  });

  // çº¿ï¼ˆå·¥èµ„ï¼‰
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
  ctx.lineWidth = 2;
  ctx.beginPath();
  data.forEach((d,i)=>{
    const x = pad.l + (i+0.5)*w/data.length;
    const y = pad.t + h - (d.pay/maxP)*h;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // ç‚¹
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
  data.forEach((d,i)=>{
    const x = pad.l + (i+0.5)*w/data.length;
    const y = pad.t + h - (d.pay/maxP)*h;
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  });
}

function drawHeatmap(){
  const grid = $('#heatGrid');
  grid.innerHTML='';
  // 12å‘¨ Ã— 7å¤©ï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰ï¼Œç¬¬1åˆ—æ˜¾ç¤ºå‘¨åºæ ‡ç­¾
  const weeks = weekBuckets(12); // é¡ºåºå·²æŒ‰æ—¶é—´
  const countsByDay = {}; // key: week + '_' + dow(1..7)
  state.shifts.forEach(sh=>{
    const wk = getWeekKey(sh.date);
    const d = new Date(sh.date+'T00:00:00');
    let dow = (d.getUTCDay()+6)%7 + 1; // 1..7
    const key = wk+'_'+dow;
    countsByDay[key] = (countsByDay[key]||0) + 1;
  });

  // é¡¶éƒ¨ç©ºç™½
  const topBlank = document.createElement('div'); topBlank.className='muted'; topBlank.style.textAlign='center'; topBlank.textContent='';
  grid.appendChild(topBlank);
  for(let k=0;k<12;k++){
    const label = document.createElement('div'); label.className='muted'; label.style.textAlign='center'; label.textContent = weeks[k]?.week.slice(5) || '';
    grid.appendChild(label);
  }
  // 7 è¡Œï¼šå‘¨ä¸€åˆ°å‘¨æ—¥
  const names = ['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'];
  for(let dow=1; dow<=7; dow++){
    const rowLabel = document.createElement('div'); rowLabel.className='muted'; rowLabel.style.fontSize='12px'; rowLabel.textContent = names[dow-1];
    grid.appendChild(rowLabel);
    for(let i=0;i<12;i++){
      const wk = weeks[i]?.week;
      const cell = document.createElement('div'); cell.className='hm-cell';
      if(wk){
        const v = countsByDay[wk+'_'+dow]||0;
        cell.dataset.v = String(Math.min(6, v));
        cell.title = `${wk} ${names[dow-1]}ï¼š${v} æ¬¡`;
      }
      grid.appendChild(cell);
    }
  }
}

/* ------------------------- æ¸²æŸ“ï¼šè®¾ç½®ï¼ˆæ—¶è–ªè§„åˆ™ï¼‰ ------------------------- */
function renderRates(){
  const list = $('#rateList');
  list.innerHTML='';
  if(state.rates.length===0){
    const h = document.createElement('div');
    h.className='hint'; h.textContent='æš‚æ— è§„åˆ™ï¼Œå·¥èµ„å°†æŒ‰ $0 è®¡ç®—ã€‚è¯·æ·»åŠ è§„åˆ™ã€‚';
    list.appendChild(h);
  }
  state.rates
    .slice()
    .sort((a,b)=>a.start.localeCompare(b.start))
    .forEach(r=>{
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `<div><strong>${r.start}â€“${r.end}</strong> Â· <span class="muted">${fmtMoney(Number(r.pay))}/h</span></div>`;
      const del = document.createElement('button'); del.className='btn flat'; del.textContent='åˆ é™¤';
      del.onclick=()=>{ state.rates = state.rates.filter(x=>x.id!==r.id); persist(); refreshAll(); };
      row.appendChild(del);
      list.appendChild(row);
    });
}

/* ------------------------- äº‹ä»¶ç»‘å®š ------------------------- */
function persist(){ db.save(state); }
function refreshAll(){
  renderHome();
  const y = Number(localStorage.getItem('calY')) || new Date().getFullYear();
  const m = Number(localStorage.getItem('calM')) || new Date().getMonth();
  buildCalendar(y,m);
  drawBarLineChart();
  drawHeatmap();
  renderRates();
}

function initDefaults(){
  // é»˜è®¤å½“å¤©
  $('#date').value = todayStr();
  // å¦‚æœæ²¡æœ‰ä»»ä½•æ—¶è–ªè§„åˆ™ï¼Œç»™ä¸¤æ¡ç¤ºä¾‹
  if(state.rates.length===0){
    state.rates = [
      {id:uid(), start:'09:00', end:'18:00', pay:30},
      {id:uid(), start:'18:00', end:'22:00', pay:40},
    ];
  }
}

function bind(){
  // åº•éƒ¨å¯¼èˆª
  $$('.tab').forEach(t=>t.addEventListener('click', ()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    switchView(t.dataset.to);
  }));
  // æ·»åŠ ç­æ¬¡
  $('#addShiftBtn').onclick=()=>{
    const date = $('#date').value;
    const start = $('#start').value;
    const end = $('#end').value;
    if(!date || !start || !end) return alert('è¯·å®Œæ•´å¡«å†™ æ—¥æœŸ / å¼€å§‹ / ç»“æŸ æ—¶é—´');
    if(parseHM(end) <= parseHM(start)) return alert('ç»“æŸæ—¶é—´éœ€æ™šäºå¼€å§‹æ—¶é—´ï¼ˆè·¨åˆå¤œè¯·æ‹†åˆ†ä¸ºä¸¤æ¡è®°å½•ï¼‰');
    state.shifts.push({id:uid(), date, start, end, note:$('#note').value.trim()});
    persist(); $('#note').value=''; refreshAll();
  };
  // æ¸…é™¤å½“æ—¥
  $('#clearTodayBtn').onclick=()=>{
    const d = $('#date').value || todayStr();
    if(confirm(`åˆ é™¤ ${d} çš„æ‰€æœ‰ä¸Šç­è®°å½•ï¼Ÿ`)){
      state.shifts = state.shifts.filter(x=>x.date!==d);
      persist(); refreshAll();
    }
  };
  // è®¾ç½®ï¼šæ·»åŠ æ—¶è–ª
  $('#addRateBtn').onclick=()=>{
    const s = $('#rateStart').value, e = $('#rateEnd').value, p = Number($('#ratePay').value);
    if(!s||!e||!(p>=0)) return alert('è¯·å¡«å†™å®Œæ•´è§„åˆ™ä¸æ­£ç¡®çš„æ—¶è–ª');
    if(parseHM(e)<=parseHM(s)) return alert('æš‚ä¸æ”¯æŒè·¨åˆå¤œè§„åˆ™ï¼Œè¯·åˆ†æˆä¸¤æ¡åœ¨ 00:00 å¤„æ–­å¼€');
    state.rates.push({id:uid(), start:s, end:e, pay:p});
    persist(); renderRates(); refreshAll();
  };
  $('#resetRateBtn').onclick=()=>{
    if(!confirm('æ¢å¤é»˜è®¤ä¸¤æ¡ç¤ºä¾‹è§„åˆ™ï¼Ÿç°æœ‰è§„åˆ™å°†è¢«è¦†ç›–ã€‚')) return;
    state.rates = [
      {id:uid(), start:'09:00', end:'18:00', pay:30},
      {id:uid(), start:'18:00', end:'22:00', pay:40},
    ];
    persist(); renderRates(); refreshAll();
  };

  // å¯¼å…¥å¯¼å‡º
  $('#exportBtn').onclick=()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'worklog-backup.json'; a.click();
    URL.revokeObjectURL(url);
  };
  $('#importFile').addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        if(!data) throw new Error('æ ¼å¼ä¸æ­£ç¡®');
        state = {
          shifts: Array.isArray(data.shifts)? data.shifts : [],
          rates: Array.isArray(data.rates)? data.rates : [],
          theme: data.theme || 'system'
        };
        applyTheme(state.theme);
        persist(); refreshAll(); renderRates();
        alert('å¯¼å…¥æˆåŠŸ');
      }catch(err){
        alert('å¯¼å…¥å¤±è´¥ï¼š'+err.message);
      }
    };
    reader.readAsText(file);
    e.target.value = '';
  });
  $('#wipeBtn').onclick=()=>{
    if(confirm('æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆä¸å¯æ¢å¤ï¼‰ï¼Ÿ')){
      state = {shifts:[], rates:[], theme: state.theme||'system'};
      persist(); refreshAll(); renderRates();
    }
  };

  // ä¸»é¢˜
  $('#themeSel').value = state.theme || 'system';
  $('#themeSel').onchange = (e)=>{
    state.theme = e.target.value; applyTheme(state.theme); persist();
  };

  // æ—¥å†åˆå§‹åŒ–
  renderCalendar();
}

function switchView(id){
  $$('.view').forEach(v=>v.classList.remove('active'));
  $('#'+id).classList.add('active');
  if(id==='v-stats'){ drawBarLineChart(); drawHeatmap(); }
}

function applyTheme(mode){
  const root = document.documentElement;
  root.removeAttribute('data-theme');
  if(mode==='light') root.setAttribute('data-theme','light');
  if(mode==='dark') root.setAttribute('data-theme','dark');
  // system -> ä¸è®¾ç½® data-themeï¼Œè·Ÿéšç³»ç»Ÿ
}

/* ------------------------- å¯åŠ¨ ------------------------- */
initDefaults();
bind();
renderRates();
applyTheme(state.theme||'system');
renderHome();
drawBarLineChart();
drawHeatmap();

/* åˆæ¬¡è¿›å…¥æŠŠæ—¥å†å®šä½åˆ°å½“æœˆ */
(function initCalPos(){
  const now = new Date();
  localStorage.setItem('calY', now.getFullYear());
  localStorage.setItem('calM', now.getMonth());
})();
</script>
</body>
</html>
